---
import Navigation from '../components/Navigation.astro';

const { title } = Astro.props;
---

<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="color-scheme" content="light dark" />
    <script is:inline>
      (() => {
        const STORAGE_KEY = 'theme';
        const root = document.documentElement;
        let theme = 'light';
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored === 'light' || stored === 'dark') theme = stored;
        } catch {}
        root.dataset.theme = theme;
        root.style.colorScheme = theme;
      })();
    </script>
    <script is:inline src="https://cdn.tailwindcss.com"></script>
    <style is:inline>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

      :root {
        --bg: #fbfaf7;
        --surface: #ffffff;
        --text: #111827;
        --muted: #4b5563;
        --border: #e5e7eb;
        --border-hover: #d1d5db;
        --link: #2563eb;
        --link-hover: #1e40af;
        --nav-bg: rgba(251, 250, 247, 0.78);
        --shadow: 0 12px 30px rgba(17, 24, 39, 0.08);
      }

      html[data-theme='dark'] {
        --bg: #0b1220;
        --surface: #0f1a2e;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --border: rgba(148, 163, 184, 0.18);
        --border-hover: rgba(148, 163, 184, 0.32);
        --link: #60a5fa;
        --link-hover: #93c5fd;
        --nav-bg: rgba(11, 18, 32, 0.6);
        --shadow: 0 16px 42px rgba(0, 0, 0, 0.35);
      }

      html {
        background: var(--bg);
      }

      body {
        font-family: 'Inter', sans-serif;
        background: var(--bg);
        color: var(--text);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      a:hover {
        color: var(--link-hover);
      }

      :focus-visible {
        outline: 2px solid var(--link);
        outline-offset: 2px;
      }

      /* Theme bridges: map existing Tailwind-ish tokens to theme vars */
      .text-white {
        color: var(--text) !important;
      }

      .text-gray-400 {
        color: var(--muted) !important;
      }

      .text-blue-400 {
        color: var(--link) !important;
      }

      .bg-gray-900 {
        background-color: var(--surface) !important;
        box-shadow: var(--shadow);
      }

      .border-gray-800 {
        border-color: var(--border) !important;
      }

      .border-gray-700 {
        border-color: var(--border-hover) !important;
      }

      .hover\\:border-gray-700:hover {
        border-color: var(--border-hover) !important;
      }

      .hover\\:text-blue-400:hover {
        color: var(--link-hover) !important;
      }

      .hover\\:text-white:hover {
        color: var(--text) !important;
      }

      /* Report/markdown readability inside card surfaces */
      .bg-gray-900 :where(h1, h2, h3) {
        color: var(--text);
        letter-spacing: -0.01em;
      }

      .bg-gray-900 :where(h2) {
        margin-top: 1.25rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
      }

      .bg-gray-900 :where(h3) {
        margin-top: 1rem;
        margin-bottom: 0.25rem;
        font-weight: 650;
      }

      .bg-gray-900 :where(p) {
        margin: 0.75rem 0;
        color: var(--text);
      }

      .bg-gray-900 :where(ul, ol) {
        margin: 0.75rem 0;
        padding-left: 1.25rem;
        color: var(--text);
      }

      .bg-gray-900 :where(li) {
        margin: 0.35rem 0;
      }

      .bg-gray-900 :where(a):not([class]) {
        color: var(--link);
        text-decoration: underline;
        text-decoration-thickness: 1px;
        text-underline-offset: 3px;
      }

      .bg-gray-900 :where(a):not([class]):hover {
        color: var(--link-hover);
      }

      .bg-gray-900 :where(code):not([class]) {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        font-size: 0.95em;
        padding: 0.12em 0.35em;
        border-radius: 0.35rem;
        background: color-mix(in srgb, var(--text) 7%, transparent);
      }

      .bg-gray-900 :where(pre) {
        margin: 1rem 0;
        padding: 0.9rem 1rem;
        border-radius: 0.9rem;
        overflow-x: auto;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--text) 6%, transparent);
      }

      .bg-gray-900 :where(pre code) {
        background: transparent;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <Navigation />
    <slot />
    <script is:inline>
      (() => {
        const makeLink = (href) => {
          const link = document.createElement('a');
          link.href = href;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          return link;
        };

        const enhanceSection = (heading) => {
          let node = heading.nextElementSibling;
          let metaList = null;

          while (node && node.tagName !== 'H2') {
            if (!metaList && node.tagName === 'UL') metaList = node;
            node = node.nextElementSibling;
          }

          if (!metaList) return;

          const sourceLi = Array.from(metaList.querySelectorAll('li')).find((li) =>
            /来源/.test(li.textContent || '')
          );

          const sourceLink = sourceLi?.querySelector('a[href]')?.getAttribute('href');

          if (!sourceLink) return;

          if (!heading.querySelector('a')) {
            const titleLink = makeLink(sourceLink);
            while (heading.firstChild) titleLink.appendChild(heading.firstChild);
            heading.appendChild(titleLink);
          } else {
            const existing = heading.querySelector('a');
            existing.setAttribute('target', '_blank');
            existing.setAttribute('rel', 'noopener noreferrer');
          }

          const summaryLi = Array.from(metaList.querySelectorAll('li')).find((li) =>
            /摘要/.test(li.textContent || '')
          );

          if (summaryLi && !summaryLi.querySelector('a')) {
            const summaryLink = makeLink(sourceLink);
            while (summaryLi.firstChild) summaryLink.appendChild(summaryLi.firstChild);
            summaryLi.appendChild(summaryLink);
          }

          if (sourceLi) sourceLi.remove();
        };

        const run = () => {
          document.querySelectorAll('.report-content h2').forEach(enhanceSection);
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', run);
        } else {
          run();
        }
      })();
    </script>
  </body>
</html>
